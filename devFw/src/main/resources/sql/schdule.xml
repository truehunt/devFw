<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="schdule">

    <select id="selectCalendar" resultType="gu.schedule.CalendarVO" parameterType="gu.schedule.MonthVO">
		SELECT CDDATE, CDDD, CDDAYOFWEEK
		  FROM COM_DATE CD
		 WHERE CDYEAR=#{year} AND CDMM=#{month}
		 ORDER BY CDDATE
    </select> 

    <select id="selectSchList4Calen" resultType="gu.schedule.SchDetailVO" parameterType="gu.common.Field3VO">
		SELECT SSNO, SDSEQ, SSTITLE, USERNO, SDHOUR, SDMINUTE, FONTCOLOR
		  FROM (
				SELECT NULL SSNO, NULL SDSEQ, SHTITLE SSTITLE, NULL USERNO, NULL SDHOUR, NULL SDMINUTE, SHCOLOR FONTCOLOR
				  FROM SCH_HOLIDAY SH
				 WHERE SHMONTH=MONTH(#{field2}) AND SHDATE=DAY(#{field2}) AND SH.DELETEFLAG='N'
				 UNION ALL
				SELECT SD.SSNO, SDSEQ, SSTITLE, USERNO, SD.SDHOUR, SD.SDMINUTE, NULL FONTCOLOR
				  FROM SCH_DETAIL SD 
				  LEFT OUTER JOIN SCH_SCHEDULE SS ON SS.SSNO=SD.SSNO 
				 WHERE SDDATE=#{field2} AND SS.DELETEFLAG='N' AND SS.SSISOPEN='Y'
				 UNION ALL
				SELECT SD.SSNO, SDSEQ, SSTITLE, USERNO, SD.SDHOUR, SD.SDMINUTE, NULL FONTCOLOR
				  FROM SCH_DETAIL SD 
				  LEFT OUTER JOIN SCH_SCHEDULE SS ON SS.SSNO=SD.SSNO 
				 WHERE SDDATE=#{field2} AND SS.DELETEFLAG='N' AND SS.SSISOPEN='N' AND USERNO=#{field1}
		 )DS
         ORDER BY SDHOUR, SDMINUTE, SSNO
    </select> 

    
    <sql id="includeSch">
        WHERE DELETEFLAG='N'
    </sql>

    <select id="selectSchCount" resultType="Integer" parameterType="gu.common.SearchVO">
        SELECT COUNT(*)
          FROM SCH_SCHEDULE TC
         <include refid="includeSch"/>
    </select> 
    
    <select id="selectSchList" resultType="gu.schedule.SchVO" parameterType="gu.common.SearchVO">
        SELECT SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR
        	 , SSENDMINUTE, SSREPEATTYPE, SSREPEATEND, SSCONTENTS, SSISOPEN, TC.USERNO, USERNM
          FROM SCH_SCHEDULE TC
         INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
         <include refid="includeSch"/>
         ORDER BY SSNO DESC
         <if test="rowStart != null">
             LIMIT ${rowStart-1}, 10
         </if>
    </select> 
        
    <insert id="insertSch" parameterType="gu.schedule.SchVO" useGeneratedKeys="true" keyProperty="ssno">
        INSERT INTO SCH_SCHEDULE(SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR, 
        			SSENDMINUTE, SSREPEATTYPE, SSREPEATOPTION, SSREPEATEND, SSCONTENTS, SSISOPEN, USERNO, UPDATEDATE, INSERTDATE, DELETEFLAG)
        VALUES (#{sstitle}, #{sstype}, #{ssstartdate}, #{ssstarthour}, #{ssstartminute}, #{ssenddate}, #{ssendhour}, 
        		#{ssendminute}, #{ssrepeattype}, #{ssrepeatoption}, #{ssrepeatend}, #{sscontents}, #{ssisopen}, #{userno}, NOW(), NOW(), 'N')
    </insert>
    
    <update id="updateSch" parameterType="gu.schedule.SchVO">
        UPDATE SCH_SCHEDULE
           SET SSTITLE=#{sstitle}, SSTYPE=#{sstype}, SSSTARTDATE=#{ssstartdate}, SSSTARTHOUR=#{ssstarthour}, SSSTARTMINUTE=#{ssstartminute}, SSENDDATE=#{ssenddate}
             , SSENDHOUR=#{ssendhour}, SSENDMINUTE=#{ssendminute}, SSREPEATTYPE=#{ssrepeattype}, SSREPEATOPTION=#{ssrepeatoption}, SSREPEATEND=#{ssrepeatend}
             , SSCONTENTS=#{sscontents}, SSISOPEN=#{ssisopen}, UPDATEDATE=NOW()
         WHERE SSNO=#{ssno} 
    </update> 

    <insert id="insertSchDetail" parameterType="gu.schedule.SchDetailVO" >
        INSERT INTO SCH_DETAIL(SSNO, SDSEQ, SDDATE, SDHOUR, SDMINUTE) 
        		VALUES(#{ssno}, #{sdseq}, #{sddate}, #{sdhour}, #{sdminute})
    </insert>
     
    <delete id="deleteSchDetail" parameterType="String">
        DELETE
          FROM SCH_DETAIL
         WHERE SSNO=#{ssno} 
    </delete>  
                
    <select id="selectSchOne" parameterType="gu.schedule.SchVO" resultType="gu.schedule.SchVO">
        SELECT SSNO, SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR 
        	 , SSENDMINUTE, SSREPEATTYPE, SSREPEATOPTION, SSREPEATEND, SSCONTENTS, SSISOPEN, TC.USERNO, USERNM
          FROM SCH_SCHEDULE TC
         INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
         WHERE TC.DELETEFLAG='N' AND SSNO=#{ssno}
    </select>  

    <select id="selectSchOne4Read" parameterType="gu.schedule.SchVO" resultType="gu.schedule.SchVO">
        SELECT SSNO, SSTITLE, CC1.CODENM SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR 
        	 , SSENDMINUTE, SSREPEATTYPE, CC2.CODENM SSREPEATTYPENM, SSREPEATEND, SSCONTENTS, CC3.CODENM SSISOPEN, TC.USERNO, USERNM
          FROM SCH_SCHEDULE TC
         INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
         INNER JOIN COM_CODE CC1 ON CC1.CODECD=TC.SSTYPE AND CC1.CLASSNO=4
         INNER JOIN COM_CODE CC2 ON CC2.CODECD=TC.SSREPEATTYPE AND CC2.CLASSNO=5
         INNER JOIN COM_CODE CC3 ON CC3.CODECD=TC.SSISOPEN AND CC3.CLASSNO=6
         WHERE TC.DELETEFLAG='N' AND SSNO=#{ssno}
    </select>  
    
    <delete id="deleteSch" parameterType="gu.schedule.SchVO">
        UPDATE SCH_SCHEDULE
           SET DELETEFLAG='Y'
         WHERE SSNO=#{ssno} 
    </delete>  
</mapper>

